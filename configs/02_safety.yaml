version: "0.1"

safety:
  purpose: "Prevent unsafe operation; keep system stable, predictable, bounded."

  invariants:
    # hard limits (never violate)
    phase_rad:
      min: -6.283185
      max: 6.283185
    coherence:
      min: 0.73
      max: 1.00
    power:
      p_draw_w:
        min: 0
        max: 120.0
      p_in_w:
        min: 0
        max: 120.0
    temperature_c:
      min: 0
      max: 55
    voltage_v:
      min: 3.0
      max: 5.5

  mismatch:
    # canonical mismatches
    power_mismatch:
      formula: "P_draw - P_in"
      warn_abs_w: 10.0
      trip_abs_w: 25.0

    phase_mismatch:
      formula: "abs(phi - phi_avg)"
      warn_abs_rad: 0.35
      trip_abs_rad: 0.70

    coherence_drop:
      formula: "max(0, C_min - coherence)"
      warn: 0.03
      trip: 0.10

  states:
    # deterministic guard states
    OK:
      description: "Normal operation"
    WARN:
      description: "Bounded anomalies; throttling enabled"
    DEGRADED:
      description: "Reduced functionality; strict limits"
    SAFE_HOLD:
      description: "Freeze output; maintain monitoring only"
    SHUTDOWN:
      description: "Stop actuation; log + require operator reset"

  transitions:
    # rule order matters: first match wins
    - from: "OK"
      to: "WARN"
      when_any:
        - "abs(power_mismatch) >= warn_abs_w"
        - "phase_mismatch >= warn_abs_rad"
        - "coherence < (C_min + warn)"
    - from: "WARN"
      to: "DEGRADED"
      when_any:
        - "abs(power_mismatch) >= trip_abs_w"
        - "phase_mismatch >= trip_abs_rad"
        - "coherence < (C_min + trip)"
    - from: "DEGRADED"
      to: "SAFE_HOLD"
      when_any:
        - "missing_sensor == true"
        - "invalid_data == true"
        - "temperature_c > max_temperature_c"
    - from: "SAFE_HOLD"
      to: "SHUTDOWN"
      when_all:
        - "safe_hold_seconds >= 30"
        - "coherence < C_min"

  actions:
    # barrier behavior (canonical): decouple + damp + cap
    warn:
      throttle:
        p_draw_max_w: 80.0
        gain_scale: 0.7
      smoothing:
        cutoff_hz: 3.0
    degraded:
      barrier:
        decouple: true
        coupling_gamma: 0.0
        damping_zeta: 0.85
        p_budget_w: 50.0
      smoothing:
        cutoff_hz: 1.5
    safe_hold:
      output:
        freeze: true
        neutral_mode: true
      barrier:
        decouple: true
        coupling_gamma: 0.0
        damping_zeta: 0.95
        p_budget_w: 10.0
    shutdown:
      output:
        off: true
      require_operator_reset: true

  sensor_rules:
    missing_sensor_policy: "SAFE_HOLD"
    invalid_data_policy: "SAFE_HOLD"
    timeout_ms: 500

  operator:
    allow_manual_override: false
    emergency_stop:
      enabled: true
      state: "SHUTDOWN"

notes:
  disclaimer: "Non-medical / non-clinical. Concept-level engineering reference."
  implementation_hint: "Keep guards deterministic; log every state change with hash."
